name: "ValidaÃ§Ã£o POC â€” EstacionamentoOn"

on:
  issues:
    types: [opened]

jobs:
  validar:
    if: contains(github.event.issue.title, '[ENTREGA]')
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Extrair link do repositÃ³rio
      id: extract
      run: |
        BODY="${{ github.event.issue.body }}"
        REPO_URL=$(echo "$BODY" | grep -o 'https://github.com/[^ )]*' | head -n 1)

        if [ -z "$REPO_URL" ]; then
          echo "repo_url=" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT

    - name: ğŸ” Verificar se o repositÃ³rio existe
      if: steps.extract.outputs.repo_url != ''
      uses: actions/github-script@v7
      with:
        script: |
          const url = "${{ steps.extract.outputs.repo_url }}";
          const parts = url.replace("https://github.com/", "").split("/");
          const owner = parts[0];
          const repo = parts[1];
          await github.repos.get({ owner, repo });

    - name: ğŸ“¥ Clonar o repositÃ³rio para anÃ¡lise
      run: |
        git clone ${{ steps.extract.outputs.repo_url }} projeto

    - name: ğŸ“„ Verificar README
      run: |
        if [ ! -f "projeto/README.md" ]; then
          echo "README ausente"
          exit 1
        fi

    - name: ğŸ§± Verificar referÃªncia ao SQLite
      run: |
        if ! grep -Rqi "sqlite" projeto; then
          echo "SQLite nÃ£o encontrado"
          exit 1
        fi

    - name: ğŸ–¼ Verificar prints no README
      run: |
        if ! grep -R "png\|jpg\|gif" -i projeto/README.md; then
          echo "Nenhuma imagem encontrada"
          exit 1
        fi

    - name: ğŸ¥ Verificar vÃ­deo no README
      run: |
        if ! grep -R "youtube\|youtu.be\|mp4" -i projeto/README.md; then
          echo "VÃ­deo nÃ£o encontrado"
          exit 1
        fi

    - name: ğŸŸ¢ Aprovado
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.issue;
          await github.issues.addLabels({ ...issue, labels: ["aprovado"] });
          await github.issues.createComment({
            ...issue,
            body: "âœ” **ValidaÃ§Ã£o concluÃ­da: APROVADO**\nSeu projeto atende aos requisitos mÃ­nimos!"
          });

    - name: ğŸ”´ Reprovado
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.issue;
          await github.issues.addLabels({ ...issue, labels: ["reprovado"] });
          await github.issues.createComment({
            ...issue,
            body: "âŒ **ValidaÃ§Ã£o concluÃ­da: REPROVADO**\nAlgum requisito obrigatÃ³rio nÃ£o foi encontrado."
          });
