name: üìä Relat√≥rio Semanal de Participa√ß√£o

on:
  schedule:
    # Executa toda segunda-feira √†s 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  generate-report:
    name: Gerar relat√≥rio semanal
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üìä Coletar estat√≠sticas
        id: stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Issues da semana
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: oneWeekAgo.toISOString(),
              per_page: 100
            });
            
            const entregas = issues.filter(i => i.labels.some(l => l.name === 'entrega'));
            const aprovados = issues.filter(i => i.labels.some(l => l.name === 'aprovado'));
            const reprovados = issues.filter(i => i.labels.some(l => l.name === 'reprovado'));
            const participantes = issues.filter(i => i.labels.some(l => l.name === 'participante'));
            
            core.setOutput('total_issues', issues.length);
            core.setOutput('entregas', entregas.length);
            core.setOutput('aprovados', aprovados.length);
            core.setOutput('reprovados', reprovados.length);
            core.setOutput('novos_participantes', participantes.length);
            
            // Top contribuidores da semana
            const contributors = {};
            entregas.forEach(issue => {
              const user = issue.user.login;
              contributors[user] = (contributors[user] || 0) + 1;
            });
            
            const topContributors = Object.entries(contributors)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5)
              .map(([user, count]) => `- @${user} (${count} entrega${count > 1 ? 's' : ''})`)
              .join('\n');
            
            core.setOutput('top_contributors', topContributors || '_Nenhum contribuidor esta semana_');
            
            return {
              totalIssues: issues.length,
              entregas: entregas.length,
              aprovados: aprovados.length,
              reprovados: reprovados.length,
              participantes: participantes.length
            };
      
      - name: üì¢ Criar Issue com relat√≥rio
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toLocaleDateString('pt-BR');
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const totalIssues = '${{ steps.stats.outputs.total_issues }}';
            const entregas = '${{ steps.stats.outputs.entregas }}';
            const aprovados = '${{ steps.stats.outputs.aprovados }}';
            const reprovados = '${{ steps.stats.outputs.reprovados }}';
            const participantes = '${{ steps.stats.outputs.novos_participantes }}';
            const topContributors = `${{ steps.stats.outputs.top_contributors }}`;
            
            const taxaAprovacao = entregas > 0 
              ? Math.round((aprovados / entregas) * 100) 
              : 0;
            
            const insights = [];
            if (entregas === 0) {
              insights.push('‚ö†Ô∏è Nenhuma entrega esta semana. Considere divulgar mais os desafios!');
            }
            if (taxaAprovacao < 50 && entregas > 0) {
              insights.push('‚ö†Ô∏è Taxa de aprova√ß√£o baixa. Verifique se as instru√ß√µes est√£o claras.');
            }
            if (taxaAprovacao >= 80 && entregas > 0) {
              insights.push('üéâ Excelente taxa de aprova√ß√£o! A comunidade est√° engajada!');
            }
            if (participantes > 5) {
              insights.push('üöÄ Crescimento acelerado de participantes! Continue assim!');
            }
            
            const reportBody = [
              '## üìä Relat√≥rio Semanal HDEV',
              '',
              `**Per√≠odo:** ${oneWeekAgo.toLocaleDateString('pt-BR')} a ${today}`,
              '',
              '---',
              '',
              '### üìà Estat√≠sticas Gerais',
              '',
              '| M√©trica | Quantidade |',
              '|---------|------------|',
              `| üéØ Entregas Recebidas | ${entregas} |`,
              `| ‚úÖ Aprovadas | ${aprovados} |`,
              `| ‚ùå Reprovadas | ${reprovados} |`,
              `| üéâ Novos Participantes | ${participantes} |`,
              `| üìä Taxa de Aprova√ß√£o | ${taxaAprovacao}% |`,
              '',
              '---',
              '',
              '### üèÜ Top Contribuidores da Semana',
              '',
              topContributors,
              '',
              '---',
              '',
              '### üí° Insights',
              '',
              insights.length > 0 ? insights.join('\n') : '_Nenhum insight significativo esta semana._',
              '',
              '---',
              '',
              '### üìã Pr√≥ximas A√ß√µes',
              '',
              '- [ ] Revisar entregas pendentes',
              '- [ ] Atualizar documenta√ß√£o (se necess√°rio)',
              '- [ ] Engajar com novos participantes',
              '- [ ] Planejar pr√≥ximos desafios',
              '',
              '---',
              '',
              '_ü§ñ Relat√≥rio gerado automaticamente toda segunda-feira √†s 9h UTC_'
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä Relat√≥rio Semanal - ${today}`,
              body: reportBody,
              labels: ['relat√≥rio', 'estat√≠sticas', 'autom√°tico']
            });


