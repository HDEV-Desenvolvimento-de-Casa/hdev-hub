name: ğŸ“Š RelatÃ³rio Semanal de ParticipaÃ§Ã£o

on:
  schedule:
    # Executa toda segunda-feira Ã s 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  generate-report:
    name: Gerar relatÃ³rio semanal
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“Š Coletar estatÃ­sticas
        id: stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Issues da semana
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: oneWeekAgo.toISOString(),
              per_page: 100
            });
            
            const entregas = issues.filter(i => i.labels.some(l => l.name === 'entrega'));
            const aprovados = issues.filter(i => i.labels.some(l => l.name === 'aprovado'));
            const reprovados = issues.filter(i => i.labels.some(l => l.name === 'reprovado'));
            const participantes = issues.filter(i => i.labels.some(l => l.name === 'participante'));
            
            core.setOutput('total_issues', issues.length);
            core.setOutput('entregas', entregas.length);
            core.setOutput('aprovados', aprovados.length);
            core.setOutput('reprovados', reprovados.length);
            core.setOutput('novos_participantes', participantes.length);
            
            // Top contribuidores da semana
            const contributors = {};
            entregas.forEach(issue => {
              const user = issue.user.login;
              contributors[user] = (contributors[user] || 0) + 1;
            });
            
            const topContributors = Object.entries(contributors)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5)
              .map(([user, count]) => `- @${user} (${count} entrega${count > 1 ? 's' : ''})`)
              .join('\n');
            
            core.setOutput('top_contributors', topContributors || '_Nenhum contribuidor esta semana_');
            
            return {
              totalIssues: issues.length,
              entregas: entregas.length,
              aprovados: aprovados.length,
              reprovados: reprovados.length,
              participantes: participantes.length
            };
      
      - name: ğŸ“¢ Criar Issue com relatÃ³rio
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toLocaleDateString('pt-BR');
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const totalIssues = '${{ steps.stats.outputs.total_issues }}';
            const entregas = '${{ steps.stats.outputs.entregas }}';
            const aprovados = '${{ steps.stats.outputs.aprovados }}';
            const reprovados = '${{ steps.stats.outputs.reprovados }}';
            const participantes = '${{ steps.stats.outputs.novos_participantes }}';
            const topContributors = `${{ steps.stats.outputs.top_contributors }}`;
            
            const taxaAprovacao = entregas > 0 
              ? Math.round((aprovados / entregas) * 100) 
              : 0;
            
            const reportBody = `## ğŸ“Š RelatÃ³rio Semanal HDEV
            
            **PerÃ­odo:** ${oneWeekAgo.toLocaleDateString('pt-BR')} a ${today}
            
            ---
            
            ### ğŸ“ˆ EstatÃ­sticas Gerais
            
            | MÃ©trica | Quantidade |
            |---------|------------|
            | ğŸ¯ Entregas Recebidas | ${entregas} |
            | âœ… Aprovadas | ${aprovados} |
            | âŒ Reprovadas | ${reprovados} |
            | ğŸ‰ Novos Participantes | ${participantes} |
            | ğŸ“Š Taxa de AprovaÃ§Ã£o | ${taxaAprovacao}% |
            
            ---
            
            ### ğŸ† Top Contribuidores da Semana
            
            ${topContributors}
            
            ---
            
            ### ğŸ’¡ Insights
            
            ${entregas === 0 ? 'âš ï¸ Nenhuma entrega esta semana. Considere divulgar mais os desafios!' : ''}
            ${taxaAprovacao < 50 && entregas > 0 ? 'âš ï¸ Taxa de aprovaÃ§Ã£o baixa. Verifique se as instruÃ§Ãµes estÃ£o claras.' : ''}
            ${taxaAprovacao >= 80 && entregas > 0 ? 'ğŸ‰ Excelente taxa de aprovaÃ§Ã£o! A comunidade estÃ¡ engajada!' : ''}
            ${participantes > 5 ? 'ğŸš€ Crescimento acelerado de participantes! Continue assim!' : ''}
            
            ---
            
            ### ğŸ“‹ PrÃ³ximas AÃ§Ãµes
            
            - [ ] Revisar entregas pendentes
            - [ ] Atualizar documentaÃ§Ã£o (se necessÃ¡rio)
            - [ ] Engajar com novos participantes
            - [ ] Planejar prÃ³ximos desafios
            
            ---
            
            _ğŸ¤– RelatÃ³rio gerado automaticamente toda segunda-feira Ã s 9h UTC_
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š RelatÃ³rio Semanal - ${today}`,
              body: reportBody,
              labels: ['relatÃ³rio', 'estatÃ­sticas', 'automÃ¡tico']
            });


